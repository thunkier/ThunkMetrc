package io.github.thunkier.thunkmetrc.wrapper.services;

import io.github.thunkier.thunkmetrc.client.MetrcClient;
import io.github.thunkier.thunkmetrc.wrapper.MetrcRateLimiter;
{{- if HasPagination .Operations }}import io.github.thunkier.thunkmetrc.wrapper.MetrcExtensions;{{ end }}
{{- if HasModels .Operations }}import io.github.thunkier.thunkmetrc.wrapper.models.*;{{ end }}
{{- if or (HasList .Operations) (HasPagination .Operations) }}import java.util.List;{{ end }}

public class {{ .Name }}Service {
    private final MetrcClient client;
    private final MetrcRateLimiter rateLimiter;

    public {{ .Name }}Service(MetrcClient client, MetrcRateLimiter rateLimiter) {
        this.client = client;
        this.rateLimiter = rateLimiter;
    }

{{- $svcName := $.Name }}
{{- range .Operations }}
{{- $methodName := ToPascalCase (CleanName .Name) }}
{{- $javaMethodName := FormatMethodName $methodName $svcName }}
{{- /* Note: No group validation here as we are already inside the service group */ -}}

{{- /* Request Model Name Resolution */ -}}
{{- $reqClassName := "" }}
{{- $isList := false }}
{{- if or (eq .Method "POST") (eq .Method "PUT") (eq .Method "PATCH") }}
    {{- if .BodySchema }}
        {{- $baseReqName := printf "%s%sRequest" $svcName $methodName }}
        {{- if eq .BodySchema.Type "array" }}
             {{- /* Logic must match generator.go: rootName + "Item" usually */ -}}
             {{- $reqClassName = printf "%sItem" $baseReqName }}
             {{- $isList = true }}
        {{- else }}
             {{- $reqClassName = $baseReqName }}
        {{- end }}
    {{- end }}
{{- end }}

    /**
{{- if .Description }}
{{ range Split (CleanDocs .Description) "\n" }}     * {{ . }}
{{ end }}{{- end }}     * {{ .Method }} {{ .Path }}
     {{- range .PathParams }}
     * @param {{ SafeJavaField . }} Path parameter
     {{- end }}
     {{- range .QueryParams }}
     * @param {{ SafeJavaField (TrimSuffix "optional" .Name) }} Query parameter
     {{- end }}
     {{- if or (eq .Method "POST") (eq .Method "PUT") (eq .Method "PATCH") }}
     * @param body Request body
     {{- end }}
     * @throws Exception If request fails
     * @return Response object
     */
    {{- if or (Contains (GetReturnType .) "List<") (Contains (GetReturnType .) "PaginatedResponse<") }}
    @SuppressWarnings("unchecked")
    {{- end }}
    public {{ GetReturnType . }} {{ $javaMethodName }}(
        {{- $args := list -}}
        {{- range .PathParams }}
        {{- $args = append $args (printf "String %s" (SafeJavaField .)) -}}
        {{- end }}
        {{- range .QueryParams }}
        {{- $name := TrimSuffix "optional" .Name }}
        {{- $args = append $args (printf "String %s" (SafeJavaField $name)) -}}
        {{- end }}
        
        {{- /* Body logic */ -}}
        {{- $callBodyArg := "null" -}}
        {{- if or (eq .Method "POST") (eq .Method "PUT") (eq .Method "PATCH") }}
            {{- if .BodySchema }}
                {{- if $isList }}
                     {{- $args = append $args (printf "List<%s> body" $reqClassName) }}
                {{- else }}
                     {{- $args = append $args (printf "%s body" $reqClassName) }}
                {{- end }}
                {{- $callBodyArg = "body" }}
            {{- else }}
                {{- $args = append $args "Object body" }}
                {{- $callBodyArg = "body" }}
            {{- end }}
        {{- end }}
        {{ join $args ", " }}
    ) throws Exception {
        return rateLimiter.execute(
            {{- /* Facility Arg */ -}}
            {{- $facilityArg := "null" -}}
            {{- range .PathParams -}}
                {{- if eq (CleanName .) "licenseNumber" -}}
                    {{- $facilityArg = (SafeJavaField .) -}}
                {{- end -}}
            {{- end -}}
            {{ $facilityArg }},
            {{- /* IsGet */ -}}
            {{- if eq .Method "GET" }}true{{ else }}false{{ end }},
            () -> ({{ GetReturnType . }}) client.{{ ToCamelCase $svcName }}.{{ $javaMethodName }}(
                {{- $callArgs := list }}
                {{- range .PathParams }}
                    {{- $callArgs = append $callArgs (SafeJavaField .) }}
                {{- end }}
                {{- range .QueryParams }}
                    {{- $callArgs = append $callArgs (SafeJavaField (TrimSuffix "optional" .Name)) }}
                {{- end }}
                {{- if or (eq .Method "POST") (eq .Method "PUT") (eq .Method "PATCH") }}
                    {{- $callArgs = append $callArgs $callBodyArg }}
                {{- end }}
                {{ join $callArgs ", " }}
            )
        );
    }

{{- end }}

}

