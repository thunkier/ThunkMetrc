package mock

import (
	"log"
	"os"
	"path/filepath"
	"regexp"
	"sort"
	"strings"
	"text/template"

	"github.com/thunkier/thunkmetrc/tools/pkg/bruno"
)

var (
	specsDir   string
	outputFile string
)

type Config struct {
	SpecsDir   string
	OutputFile string
}

func Run(cfg Config) {
	specsDir = cfg.SpecsDir
	outputFile = cfg.OutputFile

	run()
}

func run() {
	log.Println("Generating mock handlers from Bruno specs...")
	log.Printf("Specs: %s\n", specsDir)
	log.Printf("Output: %s\n", outputFile)

	collection, err := bruno.ParseCollection(specsDir)
	if err != nil {
		log.Printf("Warning: Error parsing some specs: %v", err)
	}
	log.Printf("Found %d requests in collection.\n", len(collection.Requests))

	groups := make(map[string][]bruno.Request)
	for _, req := range collection.Requests {
		if req.Group != "" {
			groups[req.Group] = append(groups[req.Group], req)
		}
	}

	var services []Service
	var groupNames []string
	for name := range groups {
		groupNames = append(groupNames, name)
	}
	sort.Strings(groupNames)

	for _, groupName := range groupNames {
		switch groupName {
		case "Packages", "Plants", "Harvests", "Items":
			continue
		}

		reqs := groups[groupName]
		sort.Slice(reqs, func(i, j int) bool {
			return reqs[i].Name < reqs[j].Name
		})

		seen := make(map[string]bool)
		var operations []Operation
		for _, req := range reqs {
			url := req.URL
			url = strings.ReplaceAll(url, "{{baseUrl}}", "")
			url = strings.ReplaceAll(url, "{{url}}", "")

			if url == "" || !strings.HasPrefix(url, "/") {
				continue
			}

			url = normalizeURL(url)

			method := strings.ToUpper(req.Method)
			routeKey := method + " " + url

			if seen[routeKey] {
				continue
			}
			seen[routeKey] = true

			operations = append(operations, Operation{
				Name:   cleanName(req.Name),
				Method: method,
				Path:   url,
				Group:  groupName,
			})
		}

		if len(operations) > 0 {
			services = append(services, Service{
				Name:       groupName,
				Operations: operations,
			})
		}
	}

	log.Printf("Generating handlers for %d services, %d total operations.\n",
		len(services), countOps(services))

	if err := generateHandlers(services, outputFile); err != nil {
		log.Fatalf("Failed to generate handlers: %v", err)
	}

	log.Printf("Generated: %s\n", outputFile)
	log.Println("Mock handler generation complete.")
}

type Service struct {
	Name       string
	Operations []Operation
}

type Operation struct {
	Name   string
	Method string
	Path   string
	Group  string
}

func countOps(services []Service) int {
	count := 0
	for _, s := range services {
		count += len(s.Operations)
	}
	return count
}

func cleanName(name string) string {
	name = strings.ReplaceAll(name, " ", "")
	name = strings.ReplaceAll(name, "-", "")
	name = strings.ReplaceAll(name, "_", "")
	name = strings.ReplaceAll(name, "(", "")
	name = strings.ReplaceAll(name, ")", "")
	name = strings.ReplaceAll(name, "/", "")
	return name
}

var pathParamRegex = regexp.MustCompile(`\{[^}]+\}`)

func normalizeURL(url string) string {
	return pathParamRegex.ReplaceAllString(url, "{id}")
}

func generateHandlers(services []Service, outPath string) error {
	if err := os.MkdirAll(filepath.Dir(outPath), 0755); err != nil {
		return err
	}

	f, err := os.Create(outPath)
	if err != nil {
		return err
	}
	defer f.Close()

	tmpl := template.Must(template.New("handlers").Parse(handlersTemplate))
	return tmpl.Execute(f, map[string]interface{}{
		"Services": services,
	})
}

const handlersTemplate = `// Code generated by mockgen. DO NOT EDIT.
package handlers

import (
	"encoding/json"
	"net/http"
)


func RegisterGeneratedRoutes(mux *http.ServeMux) {
{{- range .Services }}
	// {{ .Name }}
	{{- range .Operations }}
	mux.HandleFunc("{{ .Method }} {{ .Path }}", handleMock{{ .Method }}())
	{{- end }}
{{ end -}}
}


func handleMockGET() http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		json.NewEncoder(w).Encode([]interface{}{})
	}
}


func handleMockPOST() http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		json.NewEncoder(w).Encode(map[string]interface{}{"success": true})
	}
}


func handleMockPUT() http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		json.NewEncoder(w).Encode(map[string]interface{}{"success": true})
	}
}


func handleMockDELETE() http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(http.StatusOK)
		json.NewEncoder(w).Encode(map[string]interface{}{"success": true})
	}
}
`
