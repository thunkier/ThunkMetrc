name: Publish SDKs

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  publish-csharp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
      - name: Generate SDKs
        run: task gen:sdks
      - name: Publish C#
        run: task publish:csharp
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        if: startsWith(github.ref, 'refs/tags/')

  publish-typescript:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          registry-url: 'https://registry.npmjs.org'
          scope: '@thunkier'
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
      - name: Generate SDKs
        run: task gen:sdks
      - name: Publish TypeScript
        run: task publish:typescript
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        if: startsWith(github.ref, 'refs/tags/')

  publish-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
      - name: Generate SDKs
        run: task gen:sdks
      - name: Publish Python
        run: task publish:python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        if: startsWith(github.ref, 'refs/tags/')

  publish-java:
    runs-on: ubuntu-latest
    env:
      CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
      CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: central
          server-username: CENTRAL_USERNAME
          server-password: CENTRAL_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
      - name: Generate SDKs
        run: task gen:sdks
      - name: Publish Java
        run: task publish:java
        if: startsWith(github.ref, 'refs/tags/')

  publish-kotlin:
    runs-on: ubuntu-latest
    env:
      CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
      CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: central
          server-username: CENTRAL_USERNAME
          server-password: CENTRAL_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
      - name: Generate SDKs
        run: task gen:sdks
      - name: Publish Kotlin
        run: task publish:kotlin
        if: startsWith(github.ref, 'refs/tags/')

  publish-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25'
      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
      - name: Generate SDKs
        run: task gen:sdks
      - name: Publish Rust
        run: task publish:rust
        env:
          CARGO_TOKEN: ${{ secrets.CARGO_TOKEN }}
        if: startsWith(github.ref, 'refs/tags/')
